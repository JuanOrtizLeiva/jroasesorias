<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - JRO Asesor√≠as</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --color-bg-primary: #0a0a0a;
            --color-bg-secondary: #141414;
            --color-bg-tertiary: #1a1a1a;
            --color-text-primary: #F5F5DC;
            --color-text-secondary: #B0B0B0;
            --color-border: #2a2a2a;
            --color-accent-gold: #C9A961;
            --color-accent-gold-dark: #B08D57;
            --color-sapphire: #1a237e;
            --color-sapphire-light: #283593;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-bg-primary); 
            color: var(--color-text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-bubble {
            max-width: 80%;
            word-wrap: break-word;
            border-radius: 16px;
            padding: 12px 16px;
            margin: 8px 0;
        }

        .ai-bubble {
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.2), rgba(26, 35, 126, 0.1));
            border: 1px solid rgba(26, 35, 126, 0.3);
            align-self: flex-start;
        }

        .user-bubble {
            background: linear-gradient(135deg, rgba(201, 154, 97, 0.2), rgba(176, 141, 87, 0.1));
            border: 1px solid rgba(201, 154, 97, 0.3);
            align-self: flex-end;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-accent-gold);
            animation: loading 1.4s infinite;
            display: inline-block;
            margin: 0 2px;
        }

        @keyframes loading {
            0%, 60%, 100% { transform: scale(1); opacity: 1; }
            30% { transform: scale(1.5); opacity: 0.5; }
        }

        .btn-primary {
            background: var(--color-accent-gold);
            color: var(--color-bg-primary);
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--color-accent-gold-dark);
        }

        .warning-banner {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 8px 12px;
            text-align: center;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="bg-sapphire/20 px-4 py-3 border-b border-sapphire/30 flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-600 to-yellow-700 flex items-center justify-center">
                <i class="fas fa-robot text-black"></i>
            </div>
            <div>
                <h3 class="text-white font-semibold">JRO Assistant Pro</h3>
                <p class="text-xs text-green-400">En l√≠nea</p>
            </div>
        </div>
        <button onclick="closeChat()" class="text-gray-400 hover:text-white">
            <i class="fas fa-times text-xl"></i>
        </button>
    </div>

    <!-- Banner de advertencia -->
    <div id="warning-banner" class="warning-banner">
        <i class="fas fa-exclamation-triangle mr-1"></i>
        La ventana principal se cerr√≥. Cierra este chat para guardar la conversaci√≥n.
    </div>

    <!-- Formulario inicial -->
    <div id="chat-form-container" class="flex-1 flex items-center justify-center p-6">
        <div class="bg-gray-900 p-6 rounded-lg max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-4 text-yellow-600">
                Antes de comenzar:
            </h3>
            <input type="text" id="user-name" placeholder="Tu nombre *" required 
                   class="w-full bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded mb-3">
            <input type="email" id="user-email" placeholder="Tu email *" required
                   class="w-full bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded mb-3">
            <input type="text" id="user-company" placeholder="Tu empresa (opcional)"
                   class="w-full bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded mb-4">
            <button onclick="startChat()" class="btn-primary w-full">
                Iniciar Conversaci√≥n
            </button>
        </div>
    </div>

    <!-- Chat container (oculto inicialmente) -->
    <div id="chat-container" class="hidden flex-1 flex flex-col">
        <!-- Messages area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col">
            <!-- Los mensajes se agregar√°n aqu√≠ -->
        </div>

        <!-- Input area -->
        <div class="p-4 border-t border-gray-700">
            <div class="flex space-x-2">
                <input type="text" 
                       id="chat-input" 
                       class="flex-1 bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-600/50" 
                       placeholder="Escribe tu mensaje..."
                       onkeypress="if(event.key === 'Enter') sendMessage()"
                       oninput="resetInactivityTimer()">
                <button onclick="sendMessage()" class="btn-primary px-6">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let conversationId = null;
        let conversationHistory = [];
        let userData = {};
        let chatStartTime;
        let hasSent = false;
        let sendingInProgress = false;
        let lastSentTime = 0;
        let inactivityTimer = null;

        const POWER_AUTOMATE_URL = 'https://prod-14.westus.logic.azure.com:443/workflows/42627b4cb17d41b5a5cbeb16941f1cfd/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=KA_i7-dfQd-I30K6aFez1j3JLNIwQxOQIFcnpCGOsII';
        const API_ENDPOINT = '/.netlify/functions/chat-gemini';

        // Generar ID de conversaci√≥n √∫nico basado en fecha + email
        function generateConversationId() {
            if (!conversationId && userData.email) {
                // Crear ID √∫nico con fecha + email
                const fecha = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5); // 2025-06-22T19-18-00
                const emailBase = userData.email.split('@')[0].replace(/[^a-zA-Z0-9]/g, ''); // jortizleiva
                conversationId = `${fecha}_${emailBase}`;
                console.log('üìå ID de conversaci√≥n generado:', conversationId);
            }
            return conversationId;
        }

        // Timer de inactividad
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (conversationHistory.length > 2) {
                    console.log('‚è±Ô∏è Inactividad detectada - guardando conversaci√≥n...');
                    safeSendToPowerAutomate();
                }
            }, 60000); // 60 segundos (cambio de 30 a 60)
        }

        // Verificar si han pasado 5 segundos desde el √∫ltimo env√≠o
        function canSendAgain() {
            const now = Date.now();
            return (now - lastSentTime) > 5000; // 5 segundos (cambio de 90 a 5)
        }

        // Funci√≥n para enviar a Power Automate
        function sendToPowerAutomate() {
            console.log('üì§ Iniciando env√≠o a Power Automate...');
            console.log(`Estado actual: email=${userData.email}, mensajes=${conversationHistory.length}, conversationId=${conversationId}`);
            
            if (!userData.email || conversationHistory.length === 0) {
                console.log(`‚ùå No se envi√≥: email=${userData.email}, mensajes=${conversationHistory.length}`);
                sendingInProgress = false;
                return;
            }

            const dataToSend = {
                conversationId: conversationId,
                nombre: userData.name || 'No especificado',
                email: userData.email,
                empresa: userData.company || 'No especificada',
                fecha: new Date().toLocaleString('es-CL'),
                duracionMinutos: Math.floor((Date.now() - chatStartTime) / 60000) || 1,
                cantidadMensajes: conversationHistory.length,
                esLeadCaliente: conversationHistory.some(msg => 
                    msg.content && (
                        msg.content.toLowerCase().includes('precio') ||
                        msg.content.toLowerCase().includes('contratar') ||
                        msg.content.toLowerCase().includes('agendar') ||
                        msg.content.toLowerCase().includes('costo') ||
                        msg.content.toLowerCase().includes('cotizaci√≥n') ||
                        msg.content.toLowerCase().includes('reuni√≥n') ||
                        msg.content.toLowerCase().includes('demo') ||
                        msg.content.toLowerCase().includes('llamada')
                    )
                ),
                conversacion: conversationHistory.map(msg => ({
                    role: msg.role,
                    content: msg.content.replace(/<[^>]*>/g, '')
                }))
            };

            console.log(`Preparando datos con conversationId: ${conversationId}`);

            // Intentar con Fetch normal
            console.log('Intentando con Fetch normal...');
            
            fetch(POWER_AUTOMATE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                if (response.ok || response.status === 202) {
                    console.log(`‚úÖ Fetch exitoso! Status: ${response.status}`);
                    console.log('‚úÖ Conversaci√≥n enviada exitosamente a Power Automate');
                    lastSentTime = Date.now();
                    sendingInProgress = false;
                    
                    return response.text();
                } else {
                    throw new Error(`Status: ${response.status}`);
                }
            })
            .then(text => {
                if (text) {
                    console.log(`Respuesta de Power Automate: ${text}`);
                }
            })
            .catch(error => {
                console.log(`‚ùå Error con Fetch: ${error.message}`);
                console.error('Error en Fetch:', error);
                sendingInProgress = false;
            });
        }

        // Funci√≥n para cerrar el chat
        function closeChat() {
            console.log('üö™ Cerrando chat manualmente (bot√≥n X)...');
            safeSendToPowerAutomate();
            
            setTimeout(() => {
                console.log('Cerrando ventana...');
                window.close();
            }, 500);
        }

        // Funci√≥n segura para enviar
        function safeSendToPowerAutomate() {
            console.log(`safeSendToPowerAutomate - sendingInProgress: ${sendingInProgress}, canSendAgain: ${canSendAgain()}`);
            
            if (sendingInProgress) {
                console.log('Env√≠o ya en progreso');
                return;
            }
            
            if (!canSendAgain()) {
                console.log('Muy pronto para enviar de nuevo, esperando...');
                return;
            }
            
            sendingInProgress = true;
            sendToPowerAutomate();
        }

        // Iniciar chat
        function startChat() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const company = document.getElementById('user-company').value.trim();

            if (!name || !email) {
                alert('Por favor completa nombre y email');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Por favor ingresa un email v√°lido');
                return;
            }

            userData = { name, email, company };
            chatStartTime = Date.now();

            // Generar ID de conversaci√≥n con el primer mensaje
            generateConversationId();

            console.log(`‚úÖ Chat iniciado: ${name} (${email}) - ID: ${conversationId}`);

            // Ocultar formulario y mostrar chat
            document.getElementById('chat-form-container').classList.add('hidden');
            document.getElementById('chat-container').classList.remove('hidden');
            document.getElementById('chat-container').classList.add('flex');

            // Mensaje de bienvenida
            const welcomeMessage = `¬°Hola ${name}! üëã

Soy el asistente de JRO Asesor√≠as. Estoy aqu√≠ para ayudarte con:

‚Ä¢ Informaci√≥n sobre Power BI, Power Apps y Power Automate
‚Ä¢ C√≥mo podemos optimizar tus procesos
‚Ä¢ Detalles sobre implementaci√≥n y resultados

¬øEn qu√© puedo ayudarte hoy?`;

            appendMessage(welcomeMessage, false);
            conversationHistory.push({ role: 'assistant', content: welcomeMessage });

            document.getElementById('chat-input').focus();
            
            // Iniciar timer de inactividad
            resetInactivityTimer();
        }

        // Agregar mensaje al chat
        function appendMessage(text, isUser = false, isLoading = false) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${isUser ? 'user-bubble' : 'ai-bubble'}`;
            
            if (isLoading) {
                messageDiv.innerHTML = `
                    <div class="flex items-center space-x-1">
                        <span class="loading-dot" style="animation-delay: 0s;"></span>
                        <span class="loading-dot" style="animation-delay: 0.2s;"></span>
                        <span class="loading-dot" style="animation-delay: 0.4s;"></span>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `<p class="text-sm whitespace-pre-wrap m-0">${text}</p>`;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            console.log(`Mensaje agregado: ${isUser ? 'Usuario' : 'Asistente'} - ${text.substring(0, 50)}...`);
            
            return messageDiv;
        }

        // Enviar mensaje
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            // Resetear timer de inactividad
            resetInactivityTimer();

            console.log(`Enviando mensaje: ${message}`);

            appendMessage(message, true);
            conversationHistory.push({ role: 'user', content: message });
            input.value = '';

            // IMPORTANTE: Enviar a Power Automate despu√©s de cada mensaje del usuario
            // Sin restricciones para mensajes del usuario
            sendingInProgress = true;
            sendToPowerAutomate();

            const loadingMessage = appendMessage('', false, true);

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory.slice(-10),
                        userData: userData
                    })
                });

                loadingMessage.remove();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (data.response) {
                    appendMessage(data.response);
                    conversationHistory.push({ role: 'assistant', content: data.response });
                    console.log('Respuesta recibida correctamente');
                    
                    // Resetear timer despu√©s de recibir respuesta
                    resetInactivityTimer();
                }

            } catch (error) {
                loadingMessage.remove();
                appendMessage('Lo siento, hubo un error. Por favor contacta al +56 9 6689 5746');
                console.log(`Error en API: ${error.message}`);
            }
        }

        // üî• ESTRATEGIA DE GUARDADO INTELIGENTE

        // 1. Guardar cada 5 minutos autom√°ticamente (cambio de 2 a 5 minutos)
        setInterval(() => {
            if (conversationHistory.length > 2 && canSendAgain() && !sendingInProgress) {
                console.log('‚è∞ Guardado autom√°tico cada 5 minutos');
                safeSendToPowerAutomate();
            }
        }, 300000); // 5 minutos

        // 2. Guardar cuando la ventana pierde el foco
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && conversationHistory.length > 0 && canSendAgain()) {
                console.log('üëÅÔ∏è Ventana oculta - guardando...');
                safeSendToPowerAutomate();
            }
        });

        // 3. Guardar cuando se minimiza o cambia de pesta√±a
        window.addEventListener('blur', () => {
            setTimeout(() => {
                if (conversationHistory.length > 2 && canSendAgain() && !sendingInProgress) {
                    console.log('üîÑ Ventana perdi√≥ el foco - guardando...');
                    safeSendToPowerAutomate();
                }
            }, 1000);
        });

        // 4. Intentar con beforeunload pero sin depender de √©l
        window.addEventListener('beforeunload', (event) => {
            console.log('üö® beforeunload - √∫ltimo intento');
            if (conversationHistory.length > 0) {
                // Usar sendBeacon como √∫ltimo recurso
                const dataToSend = {
                    conversationId: conversationId,
                    nombre: userData.name || 'Usuario',
                    email: userData.email || 'no-email@test.com',
                    empresa: userData.company || 'No especificada',
                    fecha: new Date().toLocaleString('es-CL'),
                    duracionMinutos: Math.floor((Date.now() - chatStartTime) / 60000) || 1,
                    cantidadMensajes: conversationHistory.length,
                    esLeadCaliente: true,
                    conversacion: conversationHistory
                };
                
                if (navigator.sendBeacon) {
                    const blob = new Blob([JSON.stringify(dataToSend)], { type: 'application/json' });
                    navigator.sendBeacon(POWER_AUTOMATE_URL, blob);
                    console.log('üöÄ sendBeacon enviado como √∫ltimo recurso');
                }
            }
        });

        // 5. Guardar cuando se detecta intenci√≥n de cerrar
        document.addEventListener('mouseleave', (e) => {
            if (e.clientY <= 0 && conversationHistory.length > 2 && canSendAgain() && !sendingInProgress) {
                console.log('üñ±Ô∏è Mouse sali√≥ por arriba - posible cierre');
                safeSendToPowerAutomate();
            }
        });

        // 6. Detectar cuando la ventana principal se cierra
        if (window.opener) {
            setInterval(() => {
                if (window.opener.closed && conversationHistory.length > 0 && canSendAgain()) {
                    console.log('üè† Ventana principal cerrada - guardando y cerrando...');
                    safeSendToPowerAutomate();
                    setTimeout(() => window.close(), 2000);
                }
            }, 1000);
        }

        // Log inicial
        console.log('‚úÖ Chat popup v5.0 - VERSI√ìN COMPLETA SIN DEBUG');
        console.log('üìù La conversaci√≥n se guarda autom√°ticamente cuando:');
        console.log('   üì§  Env√≠as cada mensaje (INMEDIATAMENTE)');
        console.log('   ‚è±Ô∏è  Dejas de escribir por 60 segundos');
        console.log('   ‚è∞  Cada 5 minutos');
        console.log('   üîÑ  Cambias de pesta√±a o minimizas');
        console.log('   üè†  Se cierra la ventana principal');
        console.log('   üñ±Ô∏è  El mouse sale por arriba de la ventana');
        console.log('');
        console.log('üîë ID de conversaci√≥n √∫nico se genera con el primer mensaje');
        console.log('‚ö° Cada mensaje se env√≠a INMEDIATAMENTE a Power Automate');
    </script>
</body>
</html>
