<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - JRO Asesor√≠as</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Typography System - Same as main site -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Design System aligned with main site */
        :root {
            /* Primary Palette */
            --midnight-ocean: #0A1628;
            --deep-ocean: #162B4D;
            --ocean-blue: #1E3A5F;
            --steel-blue: #364F6B;
            
            /* Accent Colors */
            --emerald-growth: #10B981;
            --warm-gold: #D4AF37;
            --gold-dark: #B8860B;
            --pearl-white: #FAFBFC;
            --silk-gray: #F3F4F6;
            
            /* Functional Grays */
            --charcoal: #1F2937;
            --slate: #475569;
            --mist: #94A3B8;
            --smoke: #E2E8F0;
            
            /* Spacing */
            --space-xs: 0.382rem;
            --space-sm: 0.618rem;
            --space-md: 1rem;
            --space-lg: 1.618rem;
            --space-xl: 2.618rem;
            
            /* Shadows */
            --shadow-soft: 0 4px 6px -1px rgba(10, 22, 40, 0.07);
            --shadow-medium: 0 10px 15px -3px rgba(10, 22, 40, 0.08);
            
            /* Transitions */
            --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Border Radius */
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
        }

        body { 
            font-family: 'Instrument Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--pearl-white);
            color: var(--charcoal);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header styling */
        .chat-header {
            background: white;
            border-bottom: 1px solid var(--smoke);
            box-shadow: var(--shadow-soft);
        }

        /* Chat bubbles */
        .chat-bubble {
            max-width: 80%;
            word-wrap: break-word;
            border-radius: var(--radius-lg);
            padding: var(--space-sm) var(--space-md);
            margin: var(--space-xs) 0;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .ai-bubble {
            background: white;
            border: 1px solid var(--smoke);
            align-self: flex-start;
            box-shadow: var(--shadow-soft);
        }

        .user-bubble {
            background: var(--deep-ocean);
            color: white;
            align-self: flex-end;
        }

        /* Loading animation */
        .loading-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--ocean-blue);
            animation: loading 1.4s infinite;
            display: inline-block;
            margin: 0 2px;
        }

        @keyframes loading {
            0%, 60%, 100% { 
                transform: scale(1); 
                opacity: 0.5; 
            }
            30% { 
                transform: scale(1.5); 
                opacity: 1; 
            }
        }

        /* Button styling */
        .btn-primary {
            background: var(--deep-ocean);
            color: white;
            font-weight: 600;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-md);
            border: none;
            cursor: pointer;
            transition: all var(--transition-base);
            font-family: 'Instrument Sans', sans-serif;
        }

        .btn-primary:hover {
            background: var(--midnight-ocean);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        /* Form styling */
        .form-input {
            width: 100%;
            padding: var(--space-sm) var(--space-md);
            border: 1px solid var(--smoke);
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            transition: all var(--transition-base);
            background: white;
            color: var(--charcoal);
            font-family: 'Instrument Sans', sans-serif;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--ocean-blue);
            box-shadow: 0 0 0 3px rgba(30, 58, 95, 0.1);
        }

        /* Warning banner */
        .warning-banner {
            background: #FEF3C7;
            border: 1px solid #F59E0B;
            color: #92400E;
            padding: var(--space-xs) var(--space-sm);
            text-align: center;
            font-size: 0.75rem;
            display: none;
        }

        /* Logo SVG styling */
        .logo-icon {
            width: 36px;
            height: 36px;
        }

        /* Messages container */
        #chat-messages {
            background: var(--silk-gray);
        }

        /* Input area */
        .input-area {
            background: white;
            border-top: 1px solid var(--smoke);
            box-shadow: 0 -2px 10px rgba(10, 22, 40, 0.05);
        }

        /* Online status */
        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--emerald-growth);
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="chat-header px-4 py-3 flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div class="logo-icon">
                <!-- Logo matching main site -->
                <svg viewBox="0 0 48 48" fill="none">
                    <circle cx="24" cy="24" r="20" stroke="url(#goldGradient)" stroke-width="2"/>
                    <path d="M24 12 L36 24 L24 36 L12 24 Z" stroke="url(#goldGradient)" stroke-width="2" fill="none"/>
                    <circle cx="24" cy="24" r="4" fill="url(#goldGradient)"/>
                    <defs>
                        <linearGradient id="goldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#D4AF37;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#F4E4BC;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#B8860B;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div>
                <h3 class="font-semibold text-gray-900" style="font-family: 'Instrument Sans', sans-serif;">Asistente JRO</h3>
                <p class="text-xs text-gray-500 flex items-center gap-1">
                    <span class="status-dot"></span>
                    En l√≠nea
                </p>
            </div>
        </div>
        <button onclick="closeChat()" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-times text-xl"></i>
        </button>
    </div>

    <!-- Banner de advertencia -->
    <div id="warning-banner" class="warning-banner">
        <i class="fas fa-exclamation-triangle mr-1"></i>
        La ventana principal se cerr√≥. Cierra este chat para guardar la conversaci√≥n.
    </div>

    <!-- Formulario inicial -->
    <div id="chat-form-container" class="flex-1 flex items-center justify-center p-6" style="background-color: var(--silk-gray);">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-sm w-full">
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-50 rounded-full mb-4">
                    <svg viewBox="0 0 48 48" fill="none" width="40" height="40">
                        <circle cx="24" cy="24" r="20" stroke="url(#goldGradient2)" stroke-width="2"/>
                        <path d="M24 12 L36 24 L24 36 L12 24 Z" stroke="url(#goldGradient2)" stroke-width="2" fill="none"/>
                        <circle cx="24" cy="24" r="4" fill="url(#goldGradient2)"/>
                        <defs>
                            <linearGradient id="goldGradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#D4AF37;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#F4E4BC;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#B8860B;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2" style="font-family: 'Instrument Serif', serif;">
                    Bienvenido a JRO Asesor√≠as
                </h3>
                <p class="text-sm text-gray-600">
                    Para brindarle la mejor atenci√≥n, necesitamos algunos datos
                </p>
            </div>
            
            <div class="space-y-4">
                <input type="text" id="user-name" placeholder="Tu nombre *" required 
                       class="form-input">
                <input type="email" id="user-email" placeholder="Tu email *" required
                       class="form-input">
                <input type="text" id="user-company" placeholder="Tu empresa (opcional)"
                       class="form-input">
                <button onclick="startChat()" class="btn-primary w-full">
                    Iniciar Conversaci√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- Chat container (oculto inicialmente) -->
    <div id="chat-container" class="hidden flex-1 flex flex-col">
        <!-- Messages area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col">
            <!-- Los mensajes se agregar√°n aqu√≠ -->
        </div>

        <!-- Input area -->
        <div class="input-area p-4">
            <div class="flex space-x-2">
                <input type="text" 
                       id="chat-input" 
                       class="form-input flex-1" 
                       placeholder="Escribe tu mensaje..."
                       onkeypress="if(event.key === 'Enter') sendMessage()"
                       oninput="resetInactivityTimer()">
                <button onclick="sendMessage()" class="btn-primary px-6">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2 text-center">
                Respuestas impulsadas por IA ‚Ä¢ Conversaci√≥n segura
            </p>
        </div>
    </div>

    <script>
        // Variables globales
        let conversationId = null;
        let conversationHistory = [];
        let userData = {};
        let chatStartTime;
        let hasSent = false;
        let sendingInProgress = false;
        let lastSentTime = 0;
        let inactivityTimer = null;

        const POWER_AUTOMATE_URL = 'https://prod-14.westus.logic.azure.com:443/workflows/42627b4cb17d41b5a5cbeb16941f1cfd/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=KA_i7-dfQd-I30K6aFez1j3JLNIwQxOQIFcnpCGOsII';
        const API_ENDPOINT = '/.netlify/functions/chat-gemini';

        // Generar ID de conversaci√≥n √∫nico basado en fecha + email
        function generateConversationId() {
            if (!conversationId && userData.email) {
                // Crear ID √∫nico con fecha + email
                const fecha = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5); // 2025-06-22T19-18-00
                const emailBase = userData.email.split('@')[0].replace(/[^a-zA-Z0-9]/g, ''); // jortizleiva
                conversationId = `${fecha}_${emailBase}`;
                console.log('üìå ID de conversaci√≥n generado:', conversationId);
            }
            return conversationId;
        }

        // Timer de inactividad
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if (conversationHistory.length > 2) {
                    console.log('‚è±Ô∏è Inactividad detectada - guardando conversaci√≥n...');
                    safeSendToPowerAutomate();
                }
            }, 60000); // 60 segundos
        }

        // Verificar si han pasado 5 segundos desde el √∫ltimo env√≠o
        function canSendAgain() {
            const now = Date.now();
            return (now - lastSentTime) > 5000; // 5 segundos
        }

        // Funci√≥n para enviar a Power Automate
        function sendToPowerAutomate() {
            console.log('üì§ Iniciando env√≠o a Power Automate...');
            console.log(`Estado actual: email=${userData.email}, mensajes=${conversationHistory.length}, conversationId=${conversationId}`);
            
            if (!userData.email || conversationHistory.length === 0) {
                console.log(`‚ùå No se envi√≥: email=${userData.email}, mensajes=${conversationHistory.length}`);
                sendingInProgress = false;
                return;
            }

            const dataToSend = {
                conversationId: conversationId,
                nombre: userData.name || 'No especificado',
                email: userData.email,
                empresa: userData.company || 'No especificada',
                fecha: new Date().toLocaleString('es-CL'),
                duracionMinutos: Math.floor((Date.now() - chatStartTime) / 60000) || 1,
                cantidadMensajes: conversationHistory.length,
                esLeadCaliente: conversationHistory.some(msg => 
                    msg.content && (
                        msg.content.toLowerCase().includes('precio') ||
                        msg.content.toLowerCase().includes('contratar') ||
                        msg.content.toLowerCase().includes('agendar') ||
                        msg.content.toLowerCase().includes('costo') ||
                        msg.content.toLowerCase().includes('cotizaci√≥n') ||
                        msg.content.toLowerCase().includes('reuni√≥n') ||
                        msg.content.toLowerCase().includes('demo') ||
                        msg.content.toLowerCase().includes('llamada')
                    )
                ),
                conversacion: conversationHistory.map(msg => ({
                    role: msg.role,
                    content: msg.content.replace(/<[^>]*>/g, '')
                }))
            };

            console.log(`Preparando datos con conversationId: ${conversationId}`);

            // Intentar con Fetch normal
            console.log('Intentando con Fetch normal...');
            
            fetch(POWER_AUTOMATE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                if (response.ok || response.status === 202) {
                    console.log(`‚úÖ Fetch exitoso! Status: ${response.status}`);
                    console.log('‚úÖ Conversaci√≥n enviada exitosamente a Power Automate');
                    lastSentTime = Date.now();
                    sendingInProgress = false;
                    
                    return response.text();
                } else {
                    throw new Error(`Status: ${response.status}`);
                }
            })
            .then(text => {
                if (text) {
                    console.log(`Respuesta de Power Automate: ${text}`);
                }
            })
            .catch(error => {
                console.log(`‚ùå Error con Fetch: ${error.message}`);
                console.error('Error en Fetch:', error);
                sendingInProgress = false;
            });
        }

        // Funci√≥n para cerrar el chat
        function closeChat() {
            console.log('üö™ Cerrando chat manualmente (bot√≥n X)...');
            safeSendToPowerAutomate();
            
            setTimeout(() => {
                console.log('Cerrando ventana...');
                window.close();
            }, 500);
        }

        // Funci√≥n segura para enviar
        function safeSendToPowerAutomate() {
            console.log(`safeSendToPowerAutomate - sendingInProgress: ${sendingInProgress}, canSendAgain: ${canSendAgain()}`);
            
            if (sendingInProgress) {
                console.log('Env√≠o ya en progreso');
                return;
            }
            
            if (!canSendAgain()) {
                console.log('Muy pronto para enviar de nuevo, esperando...');
                return;
            }
            
            sendingInProgress = true;
            sendToPowerAutomate();
        }

        // Iniciar chat
        function startChat() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const company = document.getElementById('user-company').value.trim();

            if (!name || !email) {
                alert('Por favor completa nombre y email');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Por favor ingresa un email v√°lido');
                return;
            }

            userData = { name, email, company };
            chatStartTime = Date.now();

            // Generar ID de conversaci√≥n con el primer mensaje
            generateConversationId();

            console.log(`‚úÖ Chat iniciado: ${name} (${email}) - ID: ${conversationId}`);

            // Ocultar formulario y mostrar chat
            document.getElementById('chat-form-container').classList.add('hidden');
            document.getElementById('chat-container').classList.remove('hidden');
            document.getElementById('chat-container').classList.add('flex');

            // Mensaje de bienvenida
            const welcomeMessage = `¬°Hola ${name}! üëã

Soy el asistente virtual de JRO Asesor√≠as. Estoy aqu√≠ para ayudarte a descubrir c√≥mo podemos transformar tu empresa con:

‚Ä¢ **Power BI**: Dashboards ejecutivos que revelan oportunidades ocultas
‚Ä¢ **Power Automate**: Automatizaci√≥n que libera hasta 40 horas semanales
‚Ä¢ **Power Apps**: Aplicaciones empresariales sin c√≥digo

¬øQu√© desaf√≠o empresarial te gustar√≠a resolver hoy?`;

            appendMessage(welcomeMessage, false);
            conversationHistory.push({ role: 'assistant', content: welcomeMessage });

            document.getElementById('chat-input').focus();
            
            // Iniciar timer de inactividad
            resetInactivityTimer();
        }

        // Agregar mensaje al chat
        function appendMessage(text, isUser = false, isLoading = false) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${isUser ? 'user-bubble' : 'ai-bubble'}`;
            
            if (isLoading) {
                messageDiv.innerHTML = `
                    <div class="flex items-center space-x-1">
                        <span class="loading-dot" style="animation-delay: 0s;"></span>
                        <span class="loading-dot" style="animation-delay: 0.2s;"></span>
                        <span class="loading-dot" style="animation-delay: 0.4s;"></span>
                    </div>
                `;
            } else {
                // Convert markdown bold to HTML
                const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                messageDiv.innerHTML = `<p class="m-0">${formattedText}</p>`;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            console.log(`Mensaje agregado: ${isUser ? 'Usuario' : 'Asistente'} - ${text.substring(0, 50)}...`);
            
            return messageDiv;
        }

        // Enviar mensaje
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            // Resetear timer de inactividad
            resetInactivityTimer();

            console.log(`Enviando mensaje: ${message}`);

            appendMessage(message, true);
            conversationHistory.push({ role: 'user', content: message });
            input.value = '';

            // IMPORTANTE: Enviar a Power Automate despu√©s de cada mensaje del usuario
            // Sin restricciones para mensajes del usuario
            sendingInProgress = true;
            sendToPowerAutomate();

            const loadingMessage = appendMessage('', false, true);

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory.slice(-10),
                        userData: userData
                    })
                });

                loadingMessage.remove();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (data.response) {
                    appendMessage(data.response);
                    conversationHistory.push({ role: 'assistant', content: data.response });
                    console.log('Respuesta recibida correctamente');
                    
                    // Resetear timer despu√©s de recibir respuesta
                    resetInactivityTimer();
                }

            } catch (error) {
                loadingMessage.remove();
                appendMessage('Lo siento, hubo un error. Por favor contacta al +56 9 6689 5746');
                console.log(`Error en API: ${error.message}`);
            }
        }

        // üî• ESTRATEGIA DE GUARDADO INTELIGENTE

        // 1. Guardar cada 5 minutos autom√°ticamente
        setInterval(() => {
            if (conversationHistory.length > 2 && canSendAgain() && !sendingInProgress) {
                console.log('‚è∞ Guardado autom√°tico cada 5 minutos');
                safeSendToPowerAutomate();
            }
        }, 300000); // 5 minutos

        // 2. Guardar cuando la ventana pierde el foco
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && conversationHistory.length > 0 && canSendAgain()) {
                console.log('üëÅÔ∏è Ventana oculta - guardando...');
                safeSendToPowerAutomate();
            }
        });

        // 3. Guardar cuando se minimiza o cambia de pesta√±a
        window.addEventListener('blur', () => {
            setTimeout(() => {
                if (conversationHistory.length > 2 && canSendAgain() && !sendingInProgress) {
                    console.log('üîÑ Ventana perdi√≥ el foco - guardando...');
                    safeSendToPowerAutomate();
                }
            }, 1000);
        });

        // 4. Intentar con beforeunload pero sin depender de √©l
        window.addEventListener('beforeunload', (event) => {
            console.log('üö® beforeunload - √∫ltimo intento');
            if (conversationHistory.length > 0) {
                // Usar sendBeacon como √∫ltimo recurso
                const dataToSend = {
                    conversationId: conversationId,
                    nombre: userData.name || 'Usuario',
                    email: userData.email || 'no-email@test.com',
                    empresa: userData.company || 'No especificada',
                    fecha: new Date().toLocaleString('es-CL'),
                    duracionMinutos: Math.floor((Date.now() - chatStartTime) / 60000) || 1,
                    cantidadMensajes: conversationHistory.length,
                    esLeadCaliente: true,
                    conversacion: conversationHistory
                };
                
                if (navigator.sendBeacon) {
                    const blob = new Blob([JSON.stringify(dataToSend)], { type: 'application/json' });
                    navigator.sendBeacon(POWER_AUTOMATE_URL, blob);
                    console.log('üöÄ sendBeacon enviado como √∫ltimo recurso');
                }
            }
        });

        // 5. Guardar cuando se detecta intenci√≥n de cerrar
        document.addEventListener('mouseleave', (e) => {
            if (e.clientY <= 0 && conversationHistory.length > 2 && canSendAgain() && !sendingInProgress) {
                console.log('üñ±Ô∏è Mouse sali√≥ por arriba - posible cierre');
                safeSendToPowerAutomate();
            }
        });

        // 6. Detectar cuando la ventana principal se cierra
        if (window.opener) {
            setInterval(() => {
                if (window.opener.closed && conversationHistory.length > 0 && canSendAgain()) {
                    console.log('üè† Ventana principal cerrada - guardando y cerrando...');
                    safeSendToPowerAutomate();
                    document.getElementById('warning-banner').style.display = 'block';
                }
            }, 1000);
        }

        // Log inicial
        console.log('‚úÖ JRO Chat Assistant v2.0 - Premium Design');
        console.log('üé® Nuevo dise√±o alineado con la identidad de marca');
    </script>
</body>
</html>
