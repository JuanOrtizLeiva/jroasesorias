<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - JRO Asesor√≠as</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --color-bg-primary: #0a0a0a;
            --color-bg-secondary: #141414;
            --color-bg-tertiary: #1a1a1a;
            --color-text-primary: #F5F5DC;
            --color-text-secondary: #B0B0B0;
            --color-border: #2a2a2a;
            --color-accent-gold: #C9A961;
            --color-accent-gold-dark: #B08D57;
            --color-sapphire: #1a237e;
            --color-sapphire-light: #283593;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--color-bg-primary); 
            color: var(--color-text-primary);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-bubble {
            max-width: 80%;
            word-wrap: break-word;
            border-radius: 16px;
            padding: 12px 16px;
            margin: 8px 0;
        }

        .ai-bubble {
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.2), rgba(26, 35, 126, 0.1));
            border: 1px solid rgba(26, 35, 126, 0.3);
            align-self: flex-start;
        }

        .user-bubble {
            background: linear-gradient(135deg, rgba(201, 154, 97, 0.2), rgba(176, 141, 87, 0.1));
            border: 1px solid rgba(201, 154, 97, 0.3);
            align-self: flex-end;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--color-accent-gold);
            animation: loading 1.4s infinite;
            display: inline-block;
            margin: 0 2px;
        }

        @keyframes loading {
            0%, 60%, 100% { transform: scale(1); opacity: 1; }
            30% { transform: scale(1.5); opacity: 0.5; }
        }

        .btn-primary {
            background: var(--color-accent-gold);
            color: var(--color-bg-primary);
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: var(--color-accent-gold-dark);
        }

        /* Alerta de cierre */
        .warning-banner {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 8px 12px;
            text-align: center;
            font-size: 12px;
            display: none;
        }

        /* Debug panel */
        .debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #000;
            border-top: 1px solid var(--color-accent-gold);
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            display: none;
            z-index: 1000;
        }

        .debug-panel.active {
            display: block;
        }

        .debug-log {
            margin: 2px 0;
        }

        .debug-success { color: #10B981; }
        .debug-error { color: #EF4444; }
        .debug-info { color: #3B82F6; }
        .debug-warning { color: #F59E0B; }

        .debug-toggle {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: #333;
            color: #888;
            border: 1px solid #555;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            cursor: pointer;
            z-index: 1001;
        }

        .debug-toggle:hover {
            background: #444;
            color: #aaa;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="bg-sapphire/20 px-4 py-3 border-b border-sapphire/30 flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-600 to-yellow-700 flex items-center justify-center">
                <i class="fas fa-robot text-black"></i>
            </div>
            <div>
                <h3 class="text-white font-semibold">JRO Assistant Pro</h3>
                <p class="text-xs text-green-400">En l√≠nea</p>
            </div>
        </div>
        <button onclick="closeChat()" class="text-gray-400 hover:text-white">
            <i class="fas fa-times text-xl"></i>
        </button>
    </div>

    <!-- Banner de advertencia -->
    <div id="warning-banner" class="warning-banner">
        <i class="fas fa-exclamation-triangle mr-1"></i>
        La ventana principal se cerr√≥. Cierra este chat para guardar la conversaci√≥n.
    </div>

    <!-- Formulario inicial -->
    <div id="chat-form-container" class="flex-1 flex items-center justify-center p-6">
        <div class="bg-gray-900 p-6 rounded-lg max-w-sm w-full">
            <h3 class="text-lg font-semibold mb-4 text-yellow-600">
                Antes de comenzar:
            </h3>
            <input type="text" id="user-name" placeholder="Tu nombre *" required 
                   class="w-full bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded mb-3">
            <input type="email" id="user-email" placeholder="Tu email *" required
                   class="w-full bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded mb-3">
            <input type="text" id="user-company" placeholder="Tu empresa (opcional)"
                   class="w-full bg-gray-800 border border-gray-700 text-white px-4 py-2 rounded mb-4">
            <button onclick="startChat()" class="btn-primary w-full">
                Iniciar Conversaci√≥n
            </button>
        </div>
    </div>

    <!-- Chat container (oculto inicialmente) -->
    <div id="chat-container" class="hidden flex-1 flex flex-col">
        <!-- Messages area -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col">
            <!-- Los mensajes se agregar√°n aqu√≠ -->
        </div>

        <!-- Quick actions -->
        <div class="px-4 py-2 border-t border-gray-700">
            <div class="flex flex-wrap gap-2 text-xs">
                <button class="bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded-full transition-colors"
                        onclick="sendQuickMessage('¬øCu√°nto tiempo toma implementar Power BI?')">
                    ‚è±Ô∏è Tiempo
                </button>
                <button class="bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded-full transition-colors"
                        onclick="sendQuickMessage('¬øQu√© incluye el diagn√≥stico gratuito?')">
                    üìã Diagn√≥stico
                </button>
                <button class="bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded-full transition-colors"
                        onclick="sendQuickMessage('¬øCu√°l es el precio?')">
                    üí∞ Precio
                </button>
            </div>
        </div>

        <!-- Input area -->
        <div class="p-4 border-t border-gray-700">
            <div class="flex space-x-2">
                <input type="text" 
                       id="chat-input" 
                       class="flex-1 bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-yellow-600/50" 
                       placeholder="Escribe tu mensaje..."
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" class="btn-primary px-6">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Debug toggle button -->
    <button class="debug-toggle" onclick="toggleDebug()" title="Presiona Ctrl+D para activar/desactivar">
        üêõ Debug
    </button>

    <!-- Debug panel -->
    <div id="debug-panel" class="debug-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <strong style="color: var(--color-accent-gold);">Debug Console</strong>
            <button onclick="clearDebugLog()" style="background: #333; border: 1px solid #555; padding: 2px 8px; border-radius: 3px; color: #888; font-size: 10px;">Clear</button>
        </div>
        <div id="debug-log"></div>
    </div>

    <script>
        // Variables globales
        let conversationHistory = [];
        let userData = {};
        let chatStartTime;
        let hasSent = false;
        let debugMode = false;

        const POWER_AUTOMATE_URL = 'https://prod-14.westus.logic.azure.com:443/workflows/42627b4cb17d41b5a5cbeb16941f1cfd/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=KA_i7-dfQd-I30K6aFez1j3JLNIwQxOQIFcnpCGOsII';
        const API_ENDPOINT = '/.netlify/functions/chat-gemini';

        // Debug functions
        function debugLog(message, type = 'info') {
            if (!debugMode) return;
            
            const debugLogDiv = document.getElementById('debug-log');
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `debug-log debug-${type}`;
            logEntry.textContent = `[${time}] ${message}`;
            debugLogDiv.appendChild(logEntry);
            debugLogDiv.scrollTop = debugLogDiv.scrollHeight;

            // Tambi√©n log en consola
            console.log(`[DEBUG ${type.toUpperCase()}] ${message}`);
        }

        function toggleDebug() {
            debugMode = !debugMode;
            const panel = document.getElementById('debug-panel');
            panel.classList.toggle('active');
            
            if (debugMode) {
                debugLog('Modo debug activado', 'success');
                debugLog(`URL Power Automate: ${POWER_AUTOMATE_URL.substring(0, 50)}...`, 'info');
                debugLog(`Conversaci√≥n actual: ${conversationHistory.length} mensajes`, 'info');
            }
        }

        function clearDebugLog() {
            document.getElementById('debug-log').innerHTML = '';
            debugLog('Log limpiado', 'info');
        }

        // Atajo de teclado para debug (Ctrl+D)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                toggleDebug();
            }
        });

        // Funci√≥n para enviar a Power Automate
        function sendToPowerAutomate() {
            debugLog('Iniciando env√≠o a Power Automate...', 'info');
            
            if (hasSent || !userData.email || conversationHistory.length === 0) {
                debugLog(`No se envi√≥: hasSent=${hasSent}, email=${userData.email}, mensajes=${conversationHistory.length}`, 'warning');
                return;
            }

            const dataToSend = {
                nombre: userData.name || 'No especificado',
                email: userData.email,
                empresa: userData.company || 'No especificada',
                fecha: new Date().toLocaleString('es-CL'),
                duracionMinutos: Math.floor((Date.now() - chatStartTime) / 60000) || 1,
                cantidadMensajes: conversationHistory.length,
                esLeadCaliente: conversationHistory.some(msg => 
                    msg.content && (
                        msg.content.toLowerCase().includes('precio') ||
                        msg.content.toLowerCase().includes('contratar') ||
                        msg.content.toLowerCase().includes('agendar') ||
                        msg.content.toLowerCase().includes('costo') ||
                        msg.content.toLowerCase().includes('cotizaci√≥n') ||
                        msg.content.toLowerCase().includes('reuni√≥n') ||
                        msg.content.toLowerCase().includes('demo') ||
                        msg.content.toLowerCase().includes('llamada')
                    )
                ),
                conversacion: conversationHistory.map(msg => ({
                    role: msg.role,
                    content: msg.content.replace(/<[^>]*>/g, '')
                }))
            };

            debugLog(`Preparando datos: ${JSON.stringify(dataToSend).substring(0, 100)}...`, 'info');

            // Marcar como enviado inmediatamente para evitar duplicados
            hasSent = true;

            // Intentar con sendBeacon primero
            if (navigator.sendBeacon) {
                try {
                    const blob = new Blob([JSON.stringify(dataToSend)], { type: 'application/json' });
                    const sent = navigator.sendBeacon(POWER_AUTOMATE_URL, blob);
                    
                    if (sent) {
                        debugLog('‚úÖ Enviado con sendBeacon exitosamente', 'success');
                        console.log('‚úÖ Conversaci√≥n enviada con sendBeacon');
                    } else {
                        debugLog('‚ùå sendBeacon devolvi√≥ false', 'error');
                        hasSent = false; // Revertir si fall√≥
                    }
                    return sent;
                } catch (error) {
                    debugLog(`‚ùå Error en sendBeacon: ${error.message}`, 'error');
                    hasSent = false; // Revertir si fall√≥
                }
            } else {
                debugLog('‚ö†Ô∏è navigator.sendBeacon no disponible', 'warning');
            }

            // Fallback a fetch con no-cors
            debugLog('Intentando con fetch (no-cors)...', 'info');
            fetch(POWER_AUTOMATE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend),
                mode: 'no-cors',
                keepalive: true
            }).then(() => {
                debugLog('‚úÖ Enviado con fetch (no-cors)', 'success');
                console.log('‚úÖ Conversaci√≥n enviada con fetch');
            }).catch(err => {
                debugLog(`‚ùå Error en fetch: ${err.message}`, 'error');
                console.error('‚ùå Error:', err);
                hasSent = false; // Revertir si fall√≥ completamente
            });
        }

        // Funci√≥n para cerrar el chat manualmente
        function closeChat() {
            debugLog('Cerrando chat manualmente...', 'info');
            safeSendToPowerAutomate();
            setTimeout(() => window.close(), 100);
        }

        // Iniciar chat
        function startChat() {
            const name = document.getElementById('user-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const company = document.getElementById('user-company').value.trim();

            if (!name || !email) {
                alert('Por favor completa nombre y email');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Por favor ingresa un email v√°lido');
                return;
            }

            userData = { name, email, company };
            chatStartTime = Date.now();

            debugLog(`Chat iniciado: ${name} (${email})`, 'success');

            // Ocultar formulario y mostrar chat
            document.getElementById('chat-form-container').classList.add('hidden');
            document.getElementById('chat-container').classList.remove('hidden');
            document.getElementById('chat-container').classList.add('flex');

            // Mensaje de bienvenida
            const welcomeMessage = `¬°Hola ${name}! üëã

Soy el asistente de JRO Asesor√≠as. Estoy aqu√≠ para ayudarte con:

‚Ä¢ Informaci√≥n sobre Power BI, Power Apps y Power Automate
‚Ä¢ C√≥mo podemos optimizar tus procesos
‚Ä¢ Detalles sobre implementaci√≥n y resultados

¬øEn qu√© puedo ayudarte hoy?`;

            appendMessage(welcomeMessage, false);
            conversationHistory.push({ role: 'assistant', content: welcomeMessage });

            // Enfocar el input
            document.getElementById('chat-input').focus();
        }

        // Agregar mensaje al chat
        function appendMessage(text, isUser = false, isLoading = false) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-bubble ${isUser ? 'user-bubble' : 'ai-bubble'}`;
            
            if (isLoading) {
                messageDiv.innerHTML = `
                    <div class="flex items-center space-x-1">
                        <span class="loading-dot" style="animation-delay: 0s;"></span>
                        <span class="loading-dot" style="animation-delay: 0.2s;"></span>
                        <span class="loading-dot" style="animation-delay: 0.4s;"></span>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `<p class="text-sm whitespace-pre-wrap m-0">${text}</p>`;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            debugLog(`Mensaje agregado: ${isUser ? 'Usuario' : 'Asistente'} - ${text.substring(0, 50)}...`, 'info');
            
            return messageDiv;
        }

        // Enviar mensaje
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            debugLog(`Enviando mensaje: ${message}`, 'info');

            // Agregar mensaje del usuario
            appendMessage(message, true);
            conversationHistory.push({ role: 'user', content: message });
            input.value = '';

            // Mostrar loading
            const loadingMessage = appendMessage('', false, true);

            try {
                const response = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory.slice(-10),
                        userData: userData
                    })
                });

                loadingMessage.remove();

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                if (data.response) {
                    appendMessage(data.response);
                    conversationHistory.push({ role: 'assistant', content: data.response });
                    debugLog('Respuesta recibida correctamente', 'success');
                }

            } catch (error) {
                loadingMessage.remove();
                appendMessage('Lo siento, hubo un error. Por favor contacta al +56 9 6689 5746');
                debugLog(`Error en API: ${error.message}`, 'error');
            }
        }

        // Mensajes r√°pidos
        function sendQuickMessage(message) {
            document.getElementById('chat-input').value = message;
            sendMessage();
        }

        // üî• EVENTOS PARA ENVIAR LA CONVERSACI√ìN (OPTIMIZADO)

        // Variable para controlar env√≠os m√∫ltiples
        let sendingInProgress = false;

        // Funci√≥n mejorada que evita env√≠os duplicados
        function safeSendToPowerAutomate() {
            if (sendingInProgress || hasSent) {
                debugLog('Env√≠o ya en progreso o completado, evitando duplicado', 'warning');
                return;
            }
            sendingInProgress = true;
            sendToPowerAutomate();
        }

        // 1. PRINCIPAL: Cuando se cierra el popup
        window.addEventListener('beforeunload', (event) => {
            debugLog('Evento beforeunload disparado', 'warning');
            safeSendToPowerAutomate();
            
            // Notificar a la ventana principal si existe
            if (window.opener && !window.opener.closed) {
                window.opener.postMessage({ type: 'chatClosed' }, '*');
            }
        });

        // 2. BACKUP 1: Solo si beforeunload fall√≥
        window.addEventListener('pagehide', () => {
            if (!hasSent && !sendingInProgress) {
                debugLog('Evento pagehide - enviando como backup', 'warning');
                safeSendToPowerAutomate();
            }
        });

        // 3. BACKUP 2: Detectar si la ventana principal se cierra
        let parentCheckInterval = setInterval(() => {
            if (window.opener && window.opener.closed) {
                clearInterval(parentCheckInterval);
                document.getElementById('warning-banner').style.display = 'block';
                debugLog('‚ö†Ô∏è Ventana principal cerrada', 'warning');
                
                // Solo enviar si no se ha enviado a√∫n
                if (!hasSent && !sendingInProgress) {
                    setTimeout(() => {
                        safeSendToPowerAutomate();
                        setTimeout(() => window.close(), 2000);
                    }, 1000);
                }
            }
        }, 2000); // Verificar cada 2 segundos en lugar de cada segundo

        // 4. BACKUP 3: Enviar despu√©s de 10 minutos (aumentado de 5)
        setTimeout(() => {
            if (conversationHistory.length > 2 && !hasSent && !sendingInProgress) {
                debugLog('‚è±Ô∏è Backup autom√°tico despu√©s de 10 minutos', 'info');
                safeSendToPowerAutomate();
            }
        }, 600000); // 10 minutos

        // 5. REMOVIDO: Ya no enviamos por inactividad para evitar duplicados

        // 6. Si el usuario presiona ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && conversationHistory.length > 0) {
                if (confirm('¬øDeseas cerrar el chat? Se guardar√° la conversaci√≥n.')) {
                    closeChat();
                }
            }
        });

        // Log inicial
        console.log('Chat popup cargado - v1.2 optimizado (un solo env√≠o)');
    </script>
</body>
</html>
